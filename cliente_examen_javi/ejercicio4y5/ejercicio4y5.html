<!DOCTYPE html>
<html lang="en">

<head>
     <meta charset="UTF-8">
     <meta http-equiv="X-UA-Compatible" content="IE=edge">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Ejercicios 4 y 5</title>
</head>

<body>
     <script>
          let abrirConsulta = indexedDB.open("objetos", 1);
          let baseDatos;
          let alumnos = [{
                    nombre: 'Jorge',
                    idMatricula: 'DAW246',
                    modulo: 'Despliegue',
                    ciclo: 'DAW',
                    nota: 7
               },
               {
                    nombre: 'María',
                    idMatricula: 'TEAS357',
                    modulo: 'Medio natural',
                    ciclo: 'TEAS',
                    nota: 8
               },
          ];
          abrirConsulta.onsuccess = function () {
               baseDatos = abrirConsulta.result;

               baseDatos
                    .transaction('notasAlumnos', "readwrite")
                    .objectStore('notasAlumnos')
                    .clear();

               anadirDatosBaseDatos();
               anadirDatosTabla();
          }
          abrirConsulta.onerror = function () {
               alert("Error al acceder a la base de datos");
          }
          abrirConsulta.onupgradeneeded = function () {
               let baseDatos = abrirConsulta.result;

               if (!baseDatos.objectStoreNames.contains('notasAlumnos')) {
                    let registro = baseDatos.createObjectStore('notasAlumnos', {
                         keyPath: 'idMatricula'
                    });
                    registro.createIndex('indiceCiclo', 'ciclo', {
                         multiEntry: true,
                         unique: false
                    });
               }
          }
          function anadirDatosBaseDatos() {
               for (let alumno of alumnos) {
                    let insercion = baseDatos
                         .transaction('notasAlumnos', "readwrite")
                         .objectStore('notasAlumnos')
                         .put(alumno);

                    insercion.onerror = () => alert("Error al insertar los datos en la base de datos");
                    insercion.onsuccess = () => console.log("Datos insertados");
               }
          }
          function anadirDatosTabla() {
               let peticion = baseDatos
                    .transaction('notasAlumnos')
                    .objectStore('notasAlumnos')
                    .openCursor();

               peticion.onsuccess = function () {
                    let cursor = peticion.result;
                    if (cursor) {
                         anadirFilaTabla(cursor.value);
                         cursor.continue();
                    }
               };
          }
          $('#anadirFila').click(function () {

               let alumno = {
                    idMatricula: $('#idMatricula').val(),
                    nombre: $('#nombre').val(),
                    modulo: $('#modulo').val(),
                    ciclo: $('#ciclo').val(),
                    nota: $('#nota').val(),
               };
               let insercion = baseDatos
                    .transaction('notasAlumnos', "readwrite")
                    .objectStore('notasAlumnos')
                    .put(alumno);

               insercion.onerror = () => alert("Error al insertar los datos en la base de datos");
               insercion.onsuccess = () => {
                    console.log('Nueva fila insertada');
                    anadirFilaTabla(alumno);
               };
          });
          function anadirFilaTabla(alumno) {
               $('#tabla').append(`
     <tr>
          <td>${alumno.idMatricula}</td>
          <td>${alumno.nombre}</td>
          <td>${alumno.modulo}</td>
          <td>${alumno.ciclo}</td>
          <td>${alumno.nota}</td>
     </tr>
`);
          }

          $('#buscarCiclo').click(function () {
               let datosCiclos = baseDatos
                    .transaction('notasAlumnos')
                    .objectStore('notasAlumnos')
                    .index('indiceCiclo')
                    .openCursor();

               datosCiclos.onsuccess = function () {
                    let cursor = datosCiclos.result;

                    if (cursor) {
                         if ($('#indiceCiclo').val() == cursor.value.ciclo) alert(cursor.value.nombre +
                              '(' + cursor.value.idMatricula + ')');
                         cursor.continue();
                    }
               };

          });
     </script>
     <table id="tabla">
          <thead>
               <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Módulo</th>
                    <th>Ciclo</th>
                    <th>Nota</th>
               </tr>
          </thead>
     </table>


     <br><br><br>

     <form action="">
          <label for="">Nombre:</label>
          <input type="text" id="nombre">
          <br>
          <label for="">ID Matrícula:</label>
          <input type="text" id="idMatricula">
          <br>
          <label for="">Módulo:</label>
          <input type="text" id="modulo">
          <br>
          <label for="">Ciclo:</label>
          <input type="text" id="ciclo">
          <br>
          <label for="">nota:</label>
          <input type="text" id="nota">
          <br>
          <input type="button" value="Añadir" id="anadirFila">
     </form>

     <br><br><br>

     <form action="">
          <label for="">Ciclo:</label>
          <input type="text" id="indiceCiclo">
          <br>
          <input type="button" value="Buscar" id="buscarCiclo">
     </form>

     <script type="text/javascript" src="jquery-3.6.1.js"></script>
     <script type="text/javascript" src="ejercicio4y5.js"></script>
</body>

</html>